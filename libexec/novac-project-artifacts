#!/usr/bin/env ruby

# Usage: novac project-artifacts <project name>
# Summary: Lists all resources that a project has created (users, images, instances, volumes, floating ips)
# Help: "project name" is required.

$:.unshift File.expand_path("../../share/novac/lib/rb", __FILE__)
require 'rubygems'
require 'novadb2'
require 'helpers/projects'

# Ensure root or sudo is used for this command
if Process.euid != 0
  throw "Must run this script as root or use sudo."
end

# Was a project name specified?
p = nil
if ARGV[0]
  p = ARGV[0]
else
  puts "Project name or ID is required"
  exit 1
end

# All projects
# Objects
projects = Projects.new
novadb = NovaDB2.new

# Get the OpenStack Query Library
os_release = novadb.get_openstack_release
require "openstack/#{os_release}"
openstack = Object.const_get(os_release.capitalize).new

project = projects.fuzzy_search(p)
project_id = project.keys[0]
project_name = project.values[0]

puts "Project #{project_name}"
puts "ID: #{project_id}"
puts ""

puts "Users"
projects.users(project_id).each do |user_id, user_name|
  puts "* #{user_name}"
end
puts ""

puts "Images / Snapshots"
openstack.images_by_owner(project_id).each do |row|
  puts "* #{row[:name]}"
end
puts ""

novadb.regions.each do |region, creds|
  rows = openstack.instances_by_project(project_id, region)
  puts "Instances in #{region} (#{rows.count})"
  rows.each do |row|
    puts "* #{row[:display_name]}"
  end
  puts ""

  rows = openstack.volumes_by_project(project_id, region)
  puts "Volumes in #{region} (#{rows.count})"
  rows.each do |row|
    puts "* #{row[:display_name]}"
  end
  puts ""

  rows = openstack.floating_ips_by_project(project_id, region)
  puts "Floating IPs in #{region} (#{rows.count})"
  rows.each do |row|
    puts "* #{row[:address]}"
  end
  puts ""

end
